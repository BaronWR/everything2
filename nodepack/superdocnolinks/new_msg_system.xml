<node>
  <doctext>
&lt;!-- someday a real stylesheet --&gt;
&lt;style&gt;
.channelTable { border: 0; }
.channelTable td { padding: 5px; border: 1px solid black; background-color: #FOFOFO; }
.systemLine { color: gray; }
&lt;/style&gt;

&lt;table class=&quot;channelTable&quot;&gt;&lt;tr&gt;
&lt;td id=&quot;currentChannel&quot; style=&quot;vertical-align: top&quot;&gt;Select or create a channel...&lt;/td&gt;
&lt;td id=&quot;channelView&quot; rowspan=2 style=&quot;vertical-align: bottom&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td id=&quot;channelList&quot; style=&quot;vertical-align: top&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;

&lt;script&gt;

function html_escape(s) {
	return s.replace(/\&amp;/g, '&amp;amp;').replace(/\&lt;/g, '&amp;lt;').replace(/\&gt;/g, '&amp;gt;')
}

function linkUser(username) {
	return '&lt;a href=&quot;/user/' + escape(username) + '&quot;&gt;' + html_escape(username) + '&lt;/a&gt;';
}

var yourName =
[%
return '&quot;' . $$USER{title} . '&quot;';
%]
;


/* AJAX functions */


// note to self for simplifying:
// XMLHttpRequest also has a responseXML property which contains an xml doc obj


function createAjaxObject() {
	try { return new XMLHttpRequest(); }
	catch (e) { return new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;); }
}

function ajaxGet(url) {
	var request = createAjaxObject();
	
	request.open('GET', url, false);
	request.send(null);
	
	return request.responseText;
}

function ajaxPost(url, data) {
	var request = createAjaxObject();
	
	request.open('POST', url, false);
	request.setRequestHeader(&quot;Content-type&quot;, &quot;application/x-www-form-urlencoded&quot;);
	request.setRequestHeader(&quot;Content-length&quot;, data.length);
	request.setRequestHeader(&quot;Connection&quot;, &quot;close&quot;);
	request.send(data);
	
	return request.responseText;
}

function parseXml(xml) {
	try {
		parser = new DOMParser();
		xmlDoc = parser.parseFromString(xml, &quot;text/xml&quot;);
	} catch (e) {
		xmlDoc = new ActiveXObject(&quot;Microsoft.XMLDOM&quot;);
		xmlDoc.async = &quot;false&quot;;
		xmlDoc.loadXML(xml);
	}
	
	return xmlDoc;
}

/* end AJAX functions */



/* channel list */

function refreshChannelList() {
	var doc = parseXml(ajaxGet('/title/new msg system read'));
	
	var html = 'Channels: &lt;ul&gt;';
	var channel = doc.getElementsByTagName('channels')[0].firstChild;
	while (channel) {
		var chanid = channel.getAttribute('id');
		var channame = channel.getAttribute('name');
		var permission = channel.getAttribute('permission');
		
		if (permission == 1) permission = '(read-only)';
		else if (permission == 2) permission = '(read/write)';
		else if (permission == 3) permission = '(owner)';
		else permission = '';
		
		html += '&lt;li&gt;&lt;a href=&quot;#&quot; onclick=&quot;showChannel(' + chanid + '); return false;&quot;&gt;' + channame + '&lt;/a&gt; ' + permission + '&lt;/li&gt;';
		
		channel = channel.nextSibling;
	}
	html += '&lt;/ul&gt;';
	
	// add-channel control
	html += '&lt;input id=&quot;newchan&quot;&gt;';
	html += '&lt;input type=&quot;button&quot; value=&quot;new channel&quot; onclick=&quot;newChannel()&quot;&gt;';
	
	document.getElementById('channelList').innerHTML = html;
}

function newChannel() {
	var nom = document.getElementById('newchan').value;
	
	var data = 'node=new+msg+system+write&amp;action=newchannel&amp;name=' + escape(nom);
	var doc = parseXml(ajaxPost('index.pl', data));
	
	// [!] uses alert() -- prob want different UI here
	try { alert(doc.getElementsByTagName('error')[0].firstChild.nodeValue); }
	catch (e) { }
	
	// refresh the channel list to show your new channel
	refreshChannelList();
	// [ ] and show the new channel in the channel view
	//showChannel(chanid);
}


/* channel view */

function showChannel(chanid, onlybeforetime) {
	var data = 'node=new+msg+system+read&amp;viewchannel=' + chanid;
	if (onlybeforetime)
		data += '&amp;onlybeforetime=' + onlybeforetime;
	var doc = parseXml(ajaxPost('index.pl', data));
	
	var html = '';
	var curdate = '';
	var msg = doc.getElementsByTagName('messages')[0].firstChild;
	
	// show paging controls
	
	html += '&lt;div align=right&gt;';
	html += '&lt;a href=&quot;#&quot; onclick=&quot;showChannel(' + chanid + ', ' + msg.getAttribute('time') + '); return false;&quot;&gt;back&lt;/a&gt;';
	if (onlybeforetime) {
	//	html += ' | &lt;a href=&quot;#&quot; onclick=&quot;showChannel(' + chanid + ', ' + doc.getElementsByTagName('messages')[0].lastChild.getAttribute('time') + '); return false;&quot;&gt;forward&lt;/a&gt;';
		html += ' | &lt;a href=&quot;#&quot; onclick=&quot;showChannel(' + chanid + '); return false;&quot;&gt;now&lt;/a&gt;';
	}
	html += '&lt;/div&gt;';
	
	// show posts
	
	while (msg) {
		var username = msg.getAttribute('username');
		var userid = msg.getAttribute('userid');
		var time = new Date(1000 * parseInt(msg.getAttribute('time')));
		var text = msg.firstChild.nodeValue;
		
		if (curdate != time.toLocaleDateString()) {
			curdate = time.toLocaleDateString();
			html += '&lt;span class=&quot;systemLine&quot;&gt;&amp;mdash; ' + curdate + ' &amp;mdash;&lt;/span&gt;&lt;br&gt;';
		}
		
		var line = time.toLocaleTimeString() + ' &amp;lt;' + linkUser(username) + '&amp;gt; ' + text;
		if (msg.hasAttribute('system'))
			line = '&lt;span class=&quot;systemLine&quot;&gt;' + line + '&lt;/span&gt;';
		html += line + '&lt;br&gt;';
		
		msg = msg.nextSibling;
	}
	
	// posting controls
	if (onlybeforetime) {
		html += '&lt;br&gt;(you are looking at older posts to this channel - &lt;a href=&quot;#&quot; onclick=&quot;showChannel(' + chanid + '); return false;&quot;&gt;view the latest&lt;/a&gt;)&lt;br&gt;';
	} else {
		html += '&lt;br&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;&lt;div id=&quot;postcontrol&quot;&gt;';
		html += '&lt;input id=&quot;sendmsg&quot; onkeydown=&quot;sendMessage(event, ' + chanid + ')&quot;&gt;';
		html += '&lt;input type=&quot;button&quot; value=&quot;send&quot; onclick=&quot;sendMessage(null, ' + chanid + ')&quot;&gt;';
		html += '&lt;/div&gt;&lt;/td&gt;&lt;td align=right&gt;';
		html += '&lt;span id=&quot;refreshlink&quot;&gt;&lt;a href=&quot;#&quot; onclick=&quot;document.getElementById(\'refreshlink\').innerHTML = \'it loads\'; showChannel(' + chanid + '); return false;&quot;&gt;refresh&lt;/a&gt;&lt;/span&gt;';
		html += '&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;';
	}
	
	document.getElementById('channelView').innerHTML = html;
	
	// [ ] set focus to the input field 'sendmsg'
	
	// current channel view:
	
	var channame = doc.getElementsByTagName('channel')[0].getAttribute('name');
	html = '&lt;p&gt;Viewing &quot;' + html_escape(channame) + '&quot; &lt;p&gt;';
	
	var first = 1;
	var user = doc.getElementsByTagName('permissions')[0].firstChild;
	var youOwn = 0;
	while (user) {
		if (first) first = 0;
		else html += ', ';
		
		var username = user.getAttribute('name');
		var level = user.getAttribute('level');
		
		html += '  +@'[parseInt(level)];
		html += linkUser(username);
		if (username == yourName &amp;&amp; level == '3') youOwn = 1;
		
		user = user.nextSibling;
	}
	
	// current channel controls
	
	if (youOwn) {
		// set user permissions
		html += '&lt;p&gt;&lt;input id=&quot;setperm&quot;&gt;&lt;br&gt;';
		html += '&lt;select id=&quot;setpermto&quot;&gt;&lt;option value=&quot;0&quot;&gt;no access&lt;/option&gt;&lt;option value=&quot;1&quot;&gt;read-only&lt;/option&gt;&lt;option value=&quot;2&quot;&gt;read/write&lt;/option&gt;&lt;option value=&quot;3&quot;&gt;owner&lt;/option&gt;&lt;/select&gt;&lt;input type=&quot;button&quot; value=&quot;set permission&quot; onclick=&quot;setPermission(' + chanid + '); return false;&quot;&gt;';
		// change channel name
		html += '&lt;p&gt;&lt;input id=&quot;channame&quot;&gt;&lt;input type=&quot;button&quot; value=&quot;rename channel&quot; onclick=&quot;renameChannel(' + chanid + '); return false;&quot;&gt;';
	}
	
	// [ ] leave channel
	
	document.getElementById('currentChannel').innerHTML = html;
}


function setPermission(chanid) {
	var who = document.getElementById('setperm').value;
	var level = document.getElementById('setpermto').value;
	
	var data = 'node=new+msg+system+write&amp;action=setpermission&amp;channel=' + chanid + '&amp;username=' + escape(who) + '&amp;level=' + level;
	var doc = parseXml(ajaxPost('index.pl', data));
	
	// [!] uses alert() -- prob want different UI here
	try { alert(doc.getElementsByTagName('error')[0].firstChild.nodeValue); }
	catch (e) { }
	
	showChannel(chanid);
}


function renameChannel(chanid) {
	var channame = document.getElementById('channame').value;
	
	var data = 'node=new+msg+system+write&amp;action=renamechannel&amp;channel=' + chanid + '&amp;name=' + escape(channame);
	var doc = parseXml(ajaxPost('index.pl', data));
	
	// [!] uses alert() -- prob want different UI here
	try { alert(doc.getElementsByTagName('error')[0].firstChild.nodeValue); }
	catch (e) { }
	
	refreshChannelList();
	showChannel(chanid);
}


function sendMessage(event, chanid) {
	// hacky way to determine whether this is a normal keypress or a return
	if (event) {
		var keynum;
		if (window.event) keynum = event.keyCode;  // IE
		else keynum = event.which;  // others
		if (String.fromCharCode(keynum) != '\r') return;
	}
	
	var text = document.getElementById('sendmsg').value;
	document.getElementById('postcontrol').innerHTML = 'sending &quot;' + html_escape(text) + '&quot;...';
	
	var data = 'node=new+msg+system+write&amp;action=newmessage&amp;channel=' + chanid + '&amp;text=' + escape(text);
	var doc = parseXml(ajaxPost('index.pl', data));
	
	// [!] uses alert() -- prob want different UI here
	try { alert(doc.getElementsByTagName('error')[0].firstChild.nodeValue); }
	catch (e) { }
	
	// refresh the channel to show your message
	showChannel(chanid);
}


// kick it
refreshChannelList();

&lt;/script&gt;
</doctext>
  <core>0</core>
  <reputation>0</reputation>
  <lockedby_user>0</lockedby_user>
  <createtime>2009-06-04 20:12:31</createtime>
  <locktime>0000-00-00 00:00:00</locktime>
  <totalvotes>0</totalvotes>
  <hits>0</hits>
  <node_id>1988176</node_id>
  <edittime>0000-00-00 00:00:00</edittime>
  <type_nodetype>1065266</type_nodetype>
  <document_id>1988176</document_id>
  <author_user>1797883</author_user>
  <package>0</package>
  <title>new msg system</title>
</node>
