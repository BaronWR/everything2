<node>
  <doctext>&lt;pre&gt;
sub pipelink_urls {
  my $message = shift;
  while($message =~ /\bhttps?:&amp;#91;^\s&amp;lt;&amp;gt;\&quot;&amp;#93;+&amp;#91;\w\/&amp;#93;/ig) {    # contains a URL
    my $url = $&amp;;
    next if($message =~ /\&amp;#91;$url\|.+?\&amp;#93;/);               # properly pipelinkd URL
    if($message =~/\&amp;#91;$url\&amp;#93;/) {                         # hardlinked URL
      $message =~ s/\&amp;#91;$url\&amp;#93;/&amp;#91;$url|url&amp;#93;/;
    } elsif($message =~ /\&amp;#91;(.+?)\|$url\&amp;#93;/) {            # backwards pipelinked URL
      $message =~ s/\&amp;#91;(.+?)\|$url\&amp;#93;/&amp;#91;$url|$1&amp;#93;/;
    } else {                                            # unlinked URL
      $message =~ s/$url/&amp;#91;$url|url&amp;#93;/;
    }
  }
  return $message;
}

my @messages = undef;
$messages&amp;#91;0&amp;#93; = 'This message has a piped &amp;#91;http://www.everything2.com|url&amp;#93;.';
$messages&amp;#91;1&amp;#93; = 'http://www.livejournal.com';
$messages&amp;#91;2&amp;#93; = 'This message contains &amp;#91;http://www.everything2.com&amp;#93;.';
$messages&amp;#91;3&amp;#93; = 'This message has an &amp;#91;improper pipe|http://www.everyting2.com&amp;#93;.';

foreach (@messages) {
  print &quot;Before: $_\n&quot;;
  $_ = &amp;pipelink_urls($_);
  print &quot; After: $_\n\n&quot;;
}
&lt;/pre&gt;

&lt;p&gt;When the preceding script is run, the output is as follows. I have tested this script on both my VMS computer at work and my Linux computer at home.&lt;/p&gt;

&lt;pre&gt;
Before: This message has a piped &amp;#91;http://www.everything2.com|url&amp;#93;.
 After: This message has a piped &amp;#91;http://www.everything2.com|url&amp;#93;.

Before: http://www.livejournal.com
 After: &amp;#91;http://www.livejournal.com|url&amp;#93;

Before: This message contains &amp;#91;http://www.everything2.com&amp;#93;.
 After: This message contains &amp;#91;http://www.everything2.com|url&amp;#93;.

Before: This message has an &amp;#91;improper pipe|http://www.everything2.com&amp;#93;.
 After: This message has an &amp;#91;http://www.everything2.com|improper pipe&amp;#93;.
&lt;/pre&gt;</doctext>
  <createtime>2005-08-26 20:29:38</createtime>
  <totalvotes>0</totalvotes>
  <node_id>1746814</node_id>
  <edittime>0000-00-00 00:00:00</edittime>
  <type_nodetype>854232</type_nodetype>
  <document_id>1746814</document_id>
  <author_user>1458096</author_user>
  <title>jclast's external link pipelinker</title>
</node>
