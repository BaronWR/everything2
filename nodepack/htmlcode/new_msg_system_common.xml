<node>
  <createtime>2009-06-05 06:49:38</createtime>
  <node_id>1988180</node_id>
  <code>
# this hash is passed out of this htmlcode
# to the caller through $HTMLVARS{newmsg_common}
my %passout = ();

# so, pull values out like this:
## my $var = $HTMLVARS{newmsg_common}{foo}
## my $fun = $HTMLVARS{newmsg_common}{find_bar}
# and use functions: &amp;$fun(...)



##### set subroutines ######################################


# render an error page
$passout{xml_error} = sub {
	my ($msg) = @_;
	return &quot;&lt;error&gt;$msg&lt;/error&gt;&quot;;
};


# escape reserved characters
my %xml_reserved_chars = ('&quot;'=&gt;'quot', '&lt;'=&gt;'lt', '&gt;'=&gt;'gt', '&amp;'=&gt;'amp');
$passout{xml_escape} = sub {
	my ($text) = @_;
	$text =~ s/([&quot;&lt;&gt;&amp;])/\&amp;$xml_reserved_chars{$1};/g;
	return $text;
};


# return user's permission level on a channel
$passout{get_user_permission} = sub {
	my ($userid, $chanid) = @_;
	
	my $userlevel = $DB-&gt;sqlSelect('level', 'newmsg_permissions',
		&quot;channel_id=$chanid AND user_id=$userid&quot;);
	
	return ($userlevel ? int $userlevel : 0);
};



# post to a channel
$passout{post_to_channel} = sub {
	my ($chanid, $userid, $text) = @_;
	
	$DB-&gt;sqlInsert('newmsg_messages', {
		'channel_id' =&gt; $chanid,
		'user_id' =&gt; $userid,
		'timestamp' =&gt; time(),
		'text' =&gt; $text,
	});
};





##### set common variables ######################################


# this is the UID of the user used for 'system' messages
$passout{systemUID} = 1080927;  # Virgil




##### pass these suckers out ######################################

$HTMLVARS{newmsg_common} = \%passout;
</code>
  <type_nodetype>4</type_nodetype>
  <title>new msg system common</title>
</node>
