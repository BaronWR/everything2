<node>
  <node_id>1988993</node_id>
  <htmlcode_id>1988993</htmlcode_id>
  <code>my $dbh = $DB-&gt;getDatabaseHandle();

return unless htmlcode('verifyRequest', 'starrating');

my $ratingNode = int($query-&gt;param('rating_node'));
my $rating = $query-&gt;param('rating');
$rating = int($rating) if defined $rating;

return unless ($ratingNode &gt; 0
  &amp;&amp; defined $rating
  &amp;&amp; $rating &gt;= 1
  &amp;&amp; $rating &lt;= 10
);

my $selectSql = &lt;&lt;SQLEND;
SELECT
  rating_value
  FROM starrating
  WHERE starrating_id = ?
  AND rater_test_session_id = ?
  FOR UPDATE
SQLEND

my $updateSql = &lt;&lt;SQLEND;
UPDATE starrating
  SET ratingtime = now()
  , rating_value = ?
  WHERE starrating_id = ?
  AND rater_test_session_id = ?
SQLEND

my $insertSql = &lt;&lt;SQLEND;
INSERT starrating
  (rating_value, starrating_id, rater_test_session_id, user_condition, ratingtime)
  VALUES
  (?, ?, ?, ?, now())
SQLEND

my $starRateSub = sub {

  my $userCondition = htmlcode('getStarRatingCondition');
  my $sessionId = htmlcode('getStarRatingSessionId');

  my $previousRating =
    $dbh-&gt;selectrow_array($selectSql, {}, $ratingNode, $sessionId);

  if (defined $previousRating) {

    my $sth = $dbh-&gt;prepare($updateSql);
    $sth-&gt;execute($rating, $ratingNode, $sessionId);

  } else {

    my $sth = $dbh-&gt;prepare($insertSql);
    $sth-&gt;execute($rating, $ratingNode, $sessionId, $userCondition);

  }

};

$DB-&gt;transactionWrap($starRateSub);

</code>
  <type_nodetype>415056</type_nodetype>
  <title>starRate</title>
</node>
