<node>
  <doctext>&lt;p&gt;Welcome to the Everything2 Gift Shop!&lt;/p&gt;

[%

return if ($$VARS{GPoptout});

use Everything::Experience;

my $str;
my $minLevel = 1;
my $userLev = getLevel($USER);
my $userGP = $$USER{GP};
my $StarMax = 75;
my $StarMin = 25;
my $StarCost = $StarMax - (($userLev - 1) * 5);

if ($StarCost &lt; $StarMin) {$StarCost = 25};

$str.= &quot;&lt;p&gt;&lt;hr width='300' /&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;The Gift of Star&lt;/b&gt;&lt;/p&gt;&quot;;

if ($userLev &lt; $minLevel) {

$str.=&quot;&lt;p&gt;Sorry, you must be at least [Level $minLevel] to purchase a Star. Please come back when you have reached Level $minLevel.&lt;/p&gt;&quot;;

return $str;

}

$str.= &quot;&lt;p&gt;Because you are Level $minLevel or higher, you have the power to purchase a Star to reward other users. For Level $userLev users, Stars currently cost &lt;b&gt;$StarCost GP&lt;/b&gt;.&quot;;
if ($StarCost &gt; $StarMin) {
$str.=&quot; Gain another level to reduce the Star cost by 5 GP.&lt;/p&gt;&quot;;
} else {
$str.=&quot;&lt;/p&gt;&quot;;
}
$str.=&quot;&lt;p&gt;Giving a user a Star sends them a private message telling them that you have given them a Star and informing them of the reason why they earned it.&lt;/p&gt;&quot;;

if ($userGP &lt; $StarCost) {

$str.=&quot;&lt;p&gt;Sorry you do not have enough GP to buy a Star right now. Please come back when you have &lt;b&gt;$StarCost GP&lt;/b&gt;.&lt;/p&gt;&quot;;

return $str;

} else {

$str.=&quot;&lt;p&gt;You have &lt;b&gt;$userGP GP&lt;/b&gt;.&lt;/p&gt;&quot;;

}

if ($query-&gt;param('give_star')) {
	my $recipient = $query-&gt;param('givee');
        my $reason = $query-&gt;param('starReason');
        my $Color = $query-&gt;param('starColor');
	my $U = getNode($recipient, 'user');
	return &quot;&lt;p&gt;&lt;hr width='300' /&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;The Gift of Star&lt;/b&gt;&lt;/p&gt;&lt;p&gt;That user doesn't exist! Please [mauler's sandbox XI|try again].&lt;/p&gt;&quot; unless $U;
#	return &quot;&lt;p&gt;&lt;hr width='300' /&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;The Gift of Star&lt;/b&gt;&lt;/p&gt;&lt;p&gt;Sorry, you cannot give a star to yourself! Please [mauler's sandbox XI|try again].&lt;/p&gt;&quot; if ($$U{user_id} == $$USER{user_id});
        return &quot;&lt;p&gt;&lt;hr width='300' /&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;The Gift of Star&lt;/b&gt;&lt;/p&gt;&lt;p&gt;You must enter a reason. Please [mauler's sandbox XI|try again].&lt;/p&gt;&quot; unless $reason;
        $$U{stars} += 1;
	updateNode($U,-1);
        adjustGP($USER, -$StarCost);

#$DB-&gt;sqlInsert('seclog', {'seclog_user' =&gt; $$USER{node_id}, 'seclog_node' =&gt; getId(getNode('The Gift of Star', 'node_forward')), 'seclog_details' =&gt; &quot;$$USER{title} gave an $Color Star to $$U{title} at the [E2 Gift Shop] because $reason.&quot;});

	my $from = $$USER{title};
	$HTMLVARS{msgparams} = {
		'author_id' =&gt; getId(getNode('Cool Man Eddie', 'user')),
		'recipient_id' =&gt; $$U{user_id},
		'message' =&gt; &quot;Sweet! [$from] just awarded you a [Star|$Color Star], because &lt;i&gt;$reason&lt;/i&gt;&quot;
	};
	htmlcode('sendPrivateMessage','');
	$str = &quot;&lt;p&gt;&lt;hr width='300' /&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;The Gift of Star&lt;/b&gt;&lt;/p&gt;&lt;p&gt;Okay, a $Color Star has been awarded to [&quot; . $$U{title} .&quot;]. &quot;;
	if ($$USER{GP} &gt;= $StarCost) {
		return $str . &quot;You have &lt;b&gt;&quot; . $$USER{GP} . &quot;&lt;/b&gt; GP left. Would you like to [mauler's sandbox XI|give another Star]?&lt;/p&gt;&quot;;
	}
        return $str . &quot;You now have &lt;b&gt;&quot; . $$USER{GP} . &quot;&lt;/b&gt; GP left.&lt;/p&gt;&quot;;

}

$str.=$query-&gt;start_form();
$str.=$query-&gt;hidden('node_id', $$NODE{node_id});
$str.=&quot;&lt;p&gt;Yes! Please give a &quot; . $query-&gt;textfield('starColor', 'Gold', 10) . &quot; Star to noder &quot; . $query-&gt;textfield('givee');
$str.=&quot; because &quot; . $query-&gt;textfield('starReason', '', 40) . &quot;&lt;/p&gt;&quot;;
$str.=$query-&gt;submit('give_star','Star Them!');
$str.=$query-&gt;end_form();

%]</doctext>
  <core>0</core>
  <reputation>0</reputation>
  <lockedby_user>0</lockedby_user>
  <createtime>2009-05-13 14:01:11</createtime>
  <locktime>0000-00-00 00:00:00</locktime>
  <totalvotes>0</totalvotes>
  <hits>0</hits>
  <node_id>1986424</node_id>
  <edittime>0000-00-00 00:00:00</edittime>
  <type_nodetype>1144104</type_nodetype>
  <document_id>1986424</document_id>
  <author_user>1180811</author_user>
  <package>0</package>
  <title>mauler's sandbox XI</title>
</node>
