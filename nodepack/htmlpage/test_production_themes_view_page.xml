<node>
  <parent_container>0</parent_container>
  <pagetype_nodetype>7</pagetype_nodetype>
  <core>0</core>
  <page>[%
my $server = 'http://everything2.com' ;
my $theme = $query -&gt; param( 'theme' ) ;
if ( $query -&gt; param( 'usetheme' ) and $$USER{ user_id } != $HTMLVARS{ guest_user } ) {
	$$VARS{ userstyle } = $theme  ;
	return &quot;OK&quot; if $query -&gt; param( 'usetheme' ) eq 'ajax' ;
}
my $PAGE = getPage( $NODE , $query -&gt; param( 'testdisplay' ) ) ;
my $str = parseCode( $$PAGE{ page } , $NODE ) ; #currently, ecore ignores the 2nd argument
if ( $$PAGE{ parent_container } ) {
	my ( $pre , $post ) = genContainer( $$PAGE{ parent_container } ) ;
	$str = $pre.$str.$post ;
}
return $str if $query -&gt; param( 'usetheme' ) or $query -&gt; param( 'cancel' ) or
	$$USER{ user_id } == $HTMLVARS{ guest_user } ;
$str =~ s!(&lt;link rel='s.*?zensheet.*?href=').*?('.*?&gt;)!$1/?displaytype=productiontheme&amp;theme=$theme$2! ;

# Get content of theme nirvana table from production server
use LWP::Simple;
my $widget = get( &quot;$server/node/superdoc/Theme+Nirvana?displaytype=xmltrue&quot; ) ;
$widget =~ s'^.*&amp;lt;/th&amp;gt;\s*&amp;lt;/tr&amp;gt;''s ;
$widget =~ s'&amp;lt;/table.*''s ;
$widget =~ s!&amp;lt;tr.*?href=&amp;quot;(.*?)&amp;quot;&amp;gt;(.*?)&amp;lt;.*?/tr&amp;gt;!&lt;option value=&quot;$server$1&quot;&gt;$2&lt;/option&gt;!sg ;
# turn into select control

$widget = htmlcode( 'openform' , 'widget' ).
'&lt;h3 id=&quot;widgetheading&quot;&gt;Test prodution theme: &lt;em&gt;&lt;/em&gt;&lt;/h3&gt;
&lt;div&gt;
&lt;label&gt;Choose a theme:
	&lt;select name=&quot;theme&quot;&gt;
		&lt;option value=&quot;&quot; selected=&quot;selected&quot;&gt;Select stylesheet&amp;hellip;&lt;/option&gt;'.$widget.'
	&lt;/select&gt;
&lt;/label&gt;
&lt;input type=&quot;submit&quot; name=&quot;cancel&quot; value=&quot;Stop&quot;&gt;
&lt;br&gt;
&lt;small&gt;Click on links to test this theme on other pages.
Bugs to &lt;a href=&quot;/user/DonJaime&quot;&gt;DonJaime&lt;/a&gt;.&lt;/small&gt;
&lt;/div&gt;
&lt;/form&gt;
' ;

my $widgetstyle = '
&lt;style type=&quot;text/css&quot;&gt;
html body form#widget {
	position: absolute ;
	position: fixed ;
	top: 5em ; left:5em ;
	z-index: 1000000 ;
	font: 16px sans-serif normal ;
	background: #fdd ;
	color:black;
	border: 1px solid black ;
	padding: 0.25em ;
}
html body form#widget &gt; * {
	font: inherit ;
	color: inherit ;
	background: inherit ;
}
html body form#widget h3 {
	font-weight: bold ;
	margin: 0 0 0.5em ;
	padding: 0.125em 0.25em ;
	color: #ffd ;
	background: black ;
}
html body form#widget small {
	border-top: 1px solid black ;
	display: block ;
	margin-top: 0.5em ;
	font-size: 75% ;
}
'. # old IE hack:
'* html #widget { position: absolute ; }
&lt;/style&gt;
' ;

$str =~ s!(&lt;body.*?&gt;)!$1$widget! ;
$str =~ s!&lt;/head&gt;!$widgetstyle&lt;/head&gt;! ;
my $script = '
&lt;script type=&quot;text/javascript&quot;&gt;
	var zenSheet = jQuery( &quot;#zensheet&quot; ) ;
	var titletext = jQuery( &quot;#widgetheading em&quot; )[0] ;
	var theme = &quot;'.$theme.'&quot; ;
	var widget = jQuery(&quot;#widget&quot;)[0];

	widget.theme.onchange = function() {
		theme = this.value ;
		zenSheet.attr( &quot;href&quot; , &quot;/?displaytype=productiontheme&amp;theme=&quot; + this.value ) ;
		titletext.nodeValue = this[ this.selectedIndex ].firstChild.nodeValue ;
	}
	widget.cancel.onclick = function() {
		zenSheet.attr( &quot;href&quot; , &quot;'.
			htmlcode('linkstylesheet',$$VARS{ userstyle }||$$THEME{default_style},'serve').'&quot; ) ;
		cleanup() ;
		return false ;
	}
	function cleanup() {
		document.body.removeChild( widget ) ;
		for ( i = 0 , links = document.links ; links[i] ; i++ ) {
			links[i].onfocus = links[1].onblur = null ;
		}
 	}
	var savehref ;
	for ( var i = 0 , links = document.links ; links[i] ; i++ ) {
		links[i].onfocus = function(){
			savehref = this.href ;
			// cripple external link:
			if ( this.getAttribute( &quot;href&quot; ).match( /^\w+:.*$/ ) )
				this.href = &quot;/&quot; ;
			// rename any displaytype parameter:
			this.href = this.href.replace( /(\?|&amp;)displaytype=/ , &quot;$1testdisplay=&quot; ) ;
			// add parameters to existing queries:
			this.href = this.href.replace( /\?(.*)/ ,
				&quot;?displaytype=testproductionthemes&amp;theme=&quot; + theme + &quot;&amp;$1&quot; ) ;
			// add query if was none
			if ( this.href.match( /\?/ ) ) return ;
			this.href = this.href.replace( /$|(#.*)/ , &quot;?displaytype=testproductionthemes&amp;theme=&quot; + theme + &quot;$1&quot; ) ;
		}
		links[i].onblur = function(){
			this.href = savehref ;
		} ;
	}
	if (zenSheet.draggable) jQuery(widget).css(&quot;cursor&quot;, &quot;move&quot;).draggable() ;
&lt;/script&gt;
' ;
	$str =~ s!&lt;/body&gt;!$script&lt;/body&gt;! ;
	return $str  ;
%]</page>
  <reputation>0</reputation>
  <lockedby_user>0</lockedby_user>
  <createtime>2009-09-01 15:08:43</createtime>
  <locktime>0000-00-00 00:00:00</locktime>
  <totalvotes>0</totalvotes>
  <htmlpage_id>1988464</htmlpage_id>
  <hits>0</hits>
  <node_id>1988464</node_id>
  <type_nodetype>5</type_nodetype>
  <displaytype>testproductionthemes</displaytype>
  <author_user>1828141</author_user>
  <package>0</package>
  <ownedby_theme>0</ownedby_theme>
  <title>test production themes view page</title>
  <mimetype></mimetype>
</node>
